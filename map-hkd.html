<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CTS map with GPS</title>
<style>
body { font-family: system-ui; padding: 10px; }
.frame {
  position: relative;
  display: inline-block;
  width: 100%;
  padding-bottom: 56.17%; /* 画像アスペクト比 1045x587 */
}
#mapimg {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  object-fit: cover;
}
.marker {
  position: absolute;
  transform: translate(-50%, -100%);
  pointer-events: none;
  text-align: center;
}
.pin {
  width: 18px; height: 18px;
  background: rgba(220,30,30,0.95);
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,0.4);
}
.label {
  margin-top: 4px;
  background: rgba(255,255,255,0.9);
  padding: 3px 6px;
  border-radius: 4px;
  font-size: 12px;
}
button { margin-top: 10px; }
</style>
</head>
<body>

<h3>hkd.jpg 上に現在位置を表示</h3>
<div class="frame" id="frame">
  <img id="mapimg" src="hkd.jpg" alt="HKD map">
</div>

<button id="locBtn">現在位置を取得</button>
<div id="status"></div>

<script>
// DMS → 度
function d(d,m,s){ return d + m/60 + s/3600; }

// 基準点（左上, 左下, 右下）
const LT = {lat:d(42,47,28.77), lon:d(141,41,55.93)};
const LB = {lat:d(42,45,33.65), lon:d(141,40,37.89)};
const RB = {lat:d(42,45,42.58), lon:d(141,42,13.89)};

// 緯度経度 → XY（メートル）
function geoToXY(lat, lon, baseLat){
  const baseRad = baseLat*Math.PI/180;
  const Rlat = 111132.92 - 559.82*Math.cos(2*baseRad) + 1.175*Math.cos(4*baseRad);
  const Rlon = 111412.84*Math.cos(baseRad) - 93.5*Math.cos(3*baseRad);
  return {x: lon*Rlon, y: lat*Rlat};
}

let latLonToPixel;
const img = document.getElementById("mapimg");
const status = document.getElementById("status");

img.addEventListener("load", ()=>{
  const W = img.naturalWidth, H = img.naturalHeight;
  const baseLat = (LT.lat+LB.lat+RB.lat)/3;

  const LTm = geoToXY(LT.lat, LT.lon, baseLat);
  const LBm = geoToXY(LB.lat, LB.lon, baseLat);
  const RBm = geoToXY(RB.lat, RB.lon, baseLat);

  const dXLB = LBm.x-LTm.x, dYLB = LBm.y-LTm.y;
  const dXRB = RBm.x-LTm.x, dYRB = RBm.y-LTm.y;

  const A=[[dXLB,dXRB],[dYLB,dYRB]];
  const det = A[0][0]*A[1][1]-A[0][1]*A[1][0];
  if(Math.abs(det)<1e-9){ status.textContent="座標設定エラー"; return; }
  const Ai=[[A[1][1]/det,-A[0][1]/det],[-A[1][0]/det,A[0][0]/det]];

  latLonToPixel = function(lat,lon){
    const p = geoToXY(lat, lon, baseLat);
    const dx = p.x-LTm.x, dy=p.y-LTm.y;
    const u = Ai[0][0]*dx + Ai[0][1]*dy;
    const v = Ai[1][0]*dx + Ai[1][1]*dy;
    return {x: u*W, y: v*H};
  };

  status.textContent="画像読み込み完了。GPS取得可能です。";
});

// マーカー表示
function showMarker(lat, lon, acc){
  if(!latLonToPixel){ status.textContent="座標計算未完了"; return; }
  const frame=document.getElementById("frame");
  let m=document.querySelector(".marker");
  if(m) m.remove();
  const p = latLonToPixel(lat, lon);
  m=document.createElement("div");
  m.className="marker";
  m.style.left=(p.x/img.naturalWidth*100)+"%";
  m.style.top=(p.y/img.naturalHeight*100)+"%";
  m.innerHTML=`<div class="pin"></div><div class="label">${lat.toFixed(6)}, ${lon.toFixed(6)}<br>±${Math.round(acc)}m</div>`;
  frame.appendChild(m);
}

document.getElementById("locBtn").onclick=function(){
  if(!latLonToPixel||!navigator.geolocation){ status.textContent="位置情報が利用できません"; return; }
  status.textContent="位置情報取得中...";
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude, acc=pos.coords.accuracy;
    showMarker(lat, lon, acc);
    status.textContent=`取得: ${lat.toFixed(6)}, ${lon.toFixed(6)} (±${Math.round(acc)}m)`;
  }, err=>{ status.textContent="エラー: "+err.message; }, {enableHighAccuracy:true, maximumAge:3000, timeout:10000});
};
</script>

</body>
</html>
