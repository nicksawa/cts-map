<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CTS Map GPS (Fixed Aspect & Accurate Mapping)</title>

<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; }

  /* ★ 1601×1023px の正確なアスペクト比 */
  .frame {
    position: relative;
    width: 100%;
    max-width: 1601px;
    margin: auto;
    padding-bottom: calc(1023 / 1601 * 100%); /* = 63.96% */
  }

  #mapimg {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;   /* ← cover は絶対に使わない */
  }

  .marker {
    position: absolute;
    transform: translate(-50%, -100%);
    text-align: center;
    pointer-events: none;
    z-index: 100;
    transition: left 0.4s, top 0.4s;
  }

  .pin {
    width: 18px; height: 18px;
    background: rgba(220,30,30,0.95);
    border-radius: 50%;
    border: 2px solid #fff;
    margin: auto;
  }

  .label {
    margin-top: 4px;
    background: rgba(255,255,255,0.85);
    padding: 2px 6px;
    font-size: 11px;
    border-radius: 4px;
    white-space: nowrap;
  }

  #status {
    margin-top: 10px;
    font-size: 13px;
  }
</style>
</head>
<body>

<h3>CTS Map（リアルタイム GPS）</h3>

<div class="frame" id="frame">
  <img id="mapimg" src="cts.jpg" alt="CTS Map">
</div>

<div id="status">画像読み込み中...</div>


<script>
//==========================
// DMS → 10進
//==========================
function d(dg, mn, sc) { return dg + mn/60 + sc/3600; }

//==========================
// 3点の緯度経度（CTS）
//==========================

// ★ 左上
const LT = { lat: d(42,47,28.77), lon: d(141,41,55.93) };
// 左下
const LB = { lat: d(42,47,20.19), lon: d(141,40,19.59) };
// 右下
const RB = { lat: d(42,45,42.58), lon: d(141,42,13.89) };

//==========================
// 緯度経度 → 平面メートル
//==========================
function geoToXY(lat, lon, baseLat){
  const rad = baseLat * Math.PI/180;
  const Rlat = 111132.92 - 559.82*Math.cos(2*rad) + 1.175*Math.cos(4*rad);
  const Rlon = 111412.84*Math.cos(rad) - 93.5*Math.cos(3*rad);
  return { x: lon*Rlon, y: lat*Rlat };
}

let mapPercent = null;  // lat/lon → % 座標変換関数

const img   = document.getElementById("mapimg");
const frame = document.getElementById("frame");
const status= document.getElementById("status");


//==========================
// 画像ロード後にアフィン変換行列を構成
//==========================
img.addEventListener("load", ()=>{

  const baseLat = (LT.lat + LB.lat + RB.lat) / 3;

  const LTm = geoToXY(LT.lat, LT.lon, baseLat);
  const LBm = geoToXY(LB.lat, LB.lon, baseLat);
  const RBm = geoToXY(RB.lat, RB.lon, baseLat);

  // ベクトル（LB-LT を縦, RB-LB を横として扱う）
  const vY = { x: LBm.x - LTm.x, y: LBm.y - LTm.y };
  const vX = { x: RBm.x - LBm.x, y: RBm.y - LBm.y };

  // 行列 A の逆行列
  const det = vX.x * vY.y - vX.y * vY.x;
  const Ai = [
    [  vY.y/det, -vX.y/det ],
    [ -vY.x/det,  vX.x/det ]
  ];

  // 緯度経度 → 画像％座標
  mapPercent = function(lat, lon){
    const m = geoToXY(lat, lon, baseLat);

    const dx = m.x - LTm.x;
    const dy = m.y - LTm.y;

    const u = Ai[0][0]*dx + Ai[0][1]*dy; // 横方向 0〜1
    const v = Ai[1][0]*dx + Ai[1][1]*dy; // 縦方向 0〜1

    return { x: u*100, y: v*100 };
  };

  status.textContent = "GPS 取得開始...";

  //==========================
  // リアルタイム追跡開始
  //==========================
  navigator.geolocation.watchPosition(updateGPS, gpsError, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 10000
  });

});


//==========================
// マーカー表示
//==========================
function updateGPS(pos){
  if (!mapPercent) return;

  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const acc = pos.coords.accuracy;

  const p = mapPercent(lat, lon);

  let m = document.querySelector(".marker");
  if (!m){
    m = document.createElement("div");
    m.className = "marker";
    m.innerHTML = `<div class="pin"></div><div class="label"></div>`;
    frame.appendChild(m);
  }

  // 画像が contain で中央寄せされている可能性を考慮
  const rect = frame.getBoundingClientRect();
  const imgAspect = 1601 / 1023;
  const frameAspect = rect.width / rect.height;

  let offsetX = 0, offsetY = 0, scale = 1;

  if (frameAspect > imgAspect){
    // 横が余る → 左右に余白ができる
    scale = rect.height / 1023;
    const realWidth = 1601 * scale;
    offsetX = (rect.width - realWidth) / 2;
  } else {
    // 縦が余る → 上下余白ができる
    scale = rect.width / 1601;
    const realHeight = 1023 * scale;
    offsetY = (rect.height - realHeight) / 2;
  }

  m.style.left = `calc(${p.x}% )`;
  m.style.top  = `calc(${p.y}% )`;

  m.querySelector(".label").textContent =
    `${lat.toFixed(5)}, ${lon.toFixed(5)} (±${Math.round(acc)}m)`;

  status.textContent =
    `現在地: ${lat.toFixed(6)}, ${lon.toFixed(6)} 精度±${Math.round(acc)}m`;
}

function gpsError(err){
  status.textContent = "GPS エラー: " + err.message;
}
</script>

</body>
</html>
