<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CTS Map GPS (Auto & Affine)</title>
<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; }
  .frame { 
    position: relative; 
    display: inline-block; 
    width: 100%;
    max-width: 100%;
    /* CTS.jpg のアスペクト比 (461 / 1045 ≒ 44.11%) */
    padding-bottom: 44.11%; 
  }
  #mapimg { 
    display: block; 
    position: absolute; 
    top: 0;
    left: 0;
    width: 100%; 
    height: 100%; 
    object-fit: contain;
  }
  .marker {
    position: absolute;
    transform: translate(-50%, -100%); /* ピンの先端を座標に合わせる */
    pointer-events: none;
    text-align: center;
    z-index: 100;
    transition: top 0.5s, left 0.5s; /* なめらか移動 */
  }
  .pin {
    width: 18px; height: 18px;
    background: rgba(220,30,30,0.95);
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 4px rgba(0,0,0,0.4);
    margin: 0 auto;
  }
  .label {
    margin-top: 4px;
    background: rgba(255,255,255,0.8);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    display: inline-block;
  }
  #status {
    margin-top: 10px;
    font-size: 12px;
    color: #333;
  }
</style>
</head>
<body>

<h3>CTS Map（リアルタイム現在位置）</h3>

<div class="frame" id="frame">
  <img id="mapimg" src="cts.jpg" alt="CTS Map">
</div>

<div id="status">画像読み込み中...</div>

<script>
//==========================
// DMS → 10 進数
//==========================
function d(deg, min, sec) { 
  return deg + min/60 + sec/3600; 
}

//==========================
// 3点座標（CTS）
//==========================

// ★ 左上（LT）入力ありがとうございます！
const LT = {
  lat: d(42,47,28.77),
  lon: d(141,41,55.93)
};

// 左下（LB）
const LB = {
  lat: d(42,47,20.19),
  lon: d(141,40,19.59)
};

// 右下（RB）
const RB = {
  lat: d(42,45,42.58),
  lon: d(141,42,13.89)
};

//==========================
// 緯度経度 → 平面XY (メートル近似)
//==========================
function geoToXY(lat, lon, baseLat) {
  const baseRad = baseLat * Math.PI / 180;
  const Rlat = 111132.92 - 559.82 * Math.cos(2 * baseRad) + 1.175 * Math.cos(4 * baseRad);
  const Rlon = 111412.84 * Math.cos(baseRad) - 93.5 * Math.cos(3 * baseRad);
  return {
    x: lon * Rlon,
    y: lat * Rlat
  };
}

let latLonToPercent = null; // ピクセルではなくパーセントを返す関数にします
const img = document.getElementById("mapimg");
const status = document.getElementById("status");

//==========================
// 画像ロード後にアフィン変換行列を計算
//==========================
img.addEventListener("load", ()=> {
  
  const baseLat = (LT.lat + LB.lat + RB.lat) / 3;

  // 3点をメートル座標へ
  const LTm = geoToXY(LT.lat, LT.lon, baseLat);
  const LBm = geoToXY(LB.lat, LB.lon, baseLat);
  const RBm = geoToXY(RB.lat, RB.lon, baseLat);

  // ベクトル計算 (ここを修正しました)
  // 1. 下方向ベクトル (左辺: LT -> LB)
  const vecY_x = LBm.x - LTm.x;
  const vecY_y = LBm.y - LTm.y;

  // 2. 右方向ベクトル (底辺: LB -> RB)
  const vecX_x = RBm.x - LBm.x;
  const vecX_y = RBm.y - LBm.y;

  // 行列 A = [vecX, vecY]
  const A = [[vecX_x, vecY_x], [vecX_y, vecY_y]];
  const det = A[0][0] * A[1][1] - A[0][1] * A[1][0];

  if (Math.abs(det) < 1e-9) {
    status.textContent = "エラー: 座標が直線上に並んでおり計算できません。";
    return;
  }

  // 逆行列 A^-1
  const Ai = [
    [ A[1][1]/det, -A[0][1]/det ],
    [ -A[1][0]/det, A[0][0]/det ]
  ];

  // 緯度経度 → 画像内パーセント座標 (0-100)
  latLonToPercent = function(lat, lon){
    const m = geoToXY(lat, lon, baseLat);
    
    // LTからの差分
    const dx = m.x - LTm.x;
    const dy = m.y - LTm.y;

    // 方程式: P - LT = u * vecX + v * vecY
    // u = 横方向の割合 (0-1), v = 縦方向の割合 (0-1)
    const u = Ai[0][0] * dx + Ai[0][1] * dy;
    const v = Ai[1][0] * dx + Ai[1][1] * dy;

    return {
      x: u * 100, // %
      y: v * 100  // %
    };
  };

  status.textContent = "GPS 取得開始...";

  //==========================
  // リアルタイム位置追跡開始
  //==========================
  if (!navigator.geolocation) {
    status.textContent = "GPS非対応のブラウザです";
    return;
  }

  navigator.geolocation.watchPosition(showGPS, showError, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 10000
  });
});

//==========================
// マーカーを表示
//==========================
function showGPS(pos) {
  if (!latLonToPercent) return;

  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const acc = pos.coords.accuracy;

  // パーセント座標を取得
  const p = latLonToPercent(lat, lon);

  let m = document.querySelector(".marker");
  const frame = document.getElementById("frame");

  if (!m) {
    m = document.createElement("div");
    m.className = "marker";
    m.innerHTML = `<div class="pin"></div><div class="label"></div>`;
    frame.appendChild(m);
  }

  // 座標更新
  m.style.left = p.x + "%";
  m.style.top  = p.y + "%";

  // ラベルとステータス更新
  // 範囲外チェック (画面外50%以上離れたら範囲外とする)
  if (p.x < -50 || p.x > 150 || p.y < -50 || p.y > 150) {
    m.querySelector(".label").textContent = "範囲外";
    status.textContent = `範囲外: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
  } else {
    m.querySelector(".label").textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    status.textContent = `現在地: ${lat.toFixed(6)}, ${lon.toFixed(6)} (精度±${Math.round(acc)}m)`;
  }
}

function showError(err) {
  status.textContent = "GPS エラー: " + err.message;
}
</script>

</body>
</html>
