<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>CTS Map GPS</title>
<style>
  body { font-family: sans-serif; margin: 0; padding: 0; background: #333; overflow: hidden; }
  
  /* マップ表示エリア */
  .map-frame {
    position: relative;
    width: 100vw;
    height: 85vh; /* 地図エリアを広めに */
    overflow: auto;
    background: #fff;
  }
  
  /* 画像コンテナ：CTSのアスペクト比(1023/1601 ≒ 63.9%)で固定 */
  .img-container {
    position: relative;
    width: 100%;
    padding-bottom: 63.9%; 
    height: 0;
  }

  #mapimg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: block;
  }

  /* 赤いピン（現在地） */
  .marker {
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 100;
    pointer-events: none;
    transition: left 0.5s ease-out, top 0.5s ease-out; /* 滑らかに移動 */
  }
  .pin {
    width: 22px; height: 22px;
    background: rgba(255, 0, 0, 0.9);
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
  }
  /* 範囲外の時のスタイル */
  .marker.out-of-bounds { opacity: 0.4; }
  .marker.out-of-bounds .pin { background: #555; border-color: #ccc; }

  /* 下部ステータス表示 */
  .controls {
    height: 15vh;
    background: #222;
    color: white;
    padding: 15px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #status { font-size: 16px; font-weight: bold; color: #4fa; }
</style>
</head>
<body>

<div class="map-frame" id="frame">
  <div class="img-container">
    <img id="mapimg" src="cts.jpg" alt="CTS Map">
    </div>
</div>

<div class="controls">
  <div id="status">GPS準備中...</div>
</div>

<script>
//=========================================
// 1. 座標定義 (AIPの値と画像上の位置)
//=========================================
function d(deg, min, sec) { return deg + min/60 + sec/3600; }

// 地理座標（AIPより）
const GeoPoints = {
  LT: { lat: d(42,47,28.77), lon: d(141,41,55.93) },
  LB: { lat: d(42,47,20.19), lon: d(141,40,19.59) },
  RB: { lat: d(42,45,42.58), lon: d(141,42,13.89) }
};

// 画像上の位置（パーセント）
// ※青ピンで調整した結果、枠線が少し内側にあると仮定した初期値です。
// 必要に応じて微調整してください。
const InitPos = {
  LT: { x: 5,  y: 5 },
  LB: { x: 5,  y: 95 },
  RB: { x: 95, y: 95 }
};

//=========================================
// 2. システム変数・初期化
//=========================================
let mapTransform = null;
const frame = document.querySelector(".img-container");
const status = document.getElementById("status");

window.onload = () => {
  calculateMatrix(); // 変換行列を計算
  startGPS();        // GPS開始
};

//=========================================
// 3. アフィン変換行列の計算 (固定値版)
//=========================================
function geoToMeters(lat, lon, baseLat) {
  const R = 6378137; const rad = Math.PI / 180;
  const x = R * (lon * rad) * Math.cos(baseLat * rad);
  const y = R * (lat * rad);
  return { x, y };
}

function calculateMatrix() {
  const baseLat = (GeoPoints.LT.lat + GeoPoints.LB.lat + GeoPoints.RB.lat) / 3;

  // 地理座標（メートル）
  const P1 = geoToMeters(GeoPoints.LT.lat, GeoPoints.LT.lon, baseLat);
  const P2 = geoToMeters(GeoPoints.LB.lat, GeoPoints.LB.lon, baseLat);
  const P3 = geoToMeters(GeoPoints.RB.lat, GeoPoints.RB.lon, baseLat);

  // 画像座標（パーセント）- 固定値を使用
  const Q1 = InitPos.LT;
  const Q2 = InitPos.LB;
  const Q3 = InitPos.RB;

  // ベクトル計算
  const Px_v1 = P2.x - P1.x; const Py_v1 = P2.y - P1.y;
  const Px_v2 = P3.x - P1.x; const Py_v2 = P3.y - P1.y;
  const Qx_v1 = Q2.x - Q1.x; const Qy_v1 = Q2.y - Q1.y;
  const Qx_v2 = Q3.x - Q1.x; const Qy_v2 = Q3.y - Q1.y;

  // 逆行列
  const det = Px_v1 * Py_v2 - Px_v2 * Py_v1;
  if (Math.abs(det) < 1e-9) { status.textContent = "座標エラー"; return; }
  const invP = [[Py_v2/det, -Px_v2/det], [-Py_v1/det, Px_v1/det]];

  // 変換行列 M
  const m11 = Qx_v1 * invP[0][0] + Qx_v2 * invP[1][0];
  const m12 = Qx_v1 * invP[0][1] + Qx_v2 * invP[1][1];
  const m21 = Qy_v1 * invP[0][0] + Qy_v2 * invP[1][0];
  const m22 = Qy_v1 * invP[0][1] + Qy_v2 * invP[1][1];

  // 変換関数作成
  mapTransform = function(lat, lon) {
    const cur = geoToMeters(lat, lon, baseLat);
    const dx = cur.x - P1.x; const dy = cur.y - P1.y;
    return {
      x: m11 * dx + m12 * dy + Q1.x,
      y: m21 * dx + m22 * dy + Q1.y
    };
  };
}

//=========================================
// 4. GPS処理
//=========================================
function startGPS() {
  if (!navigator.geolocation) {
    status.textContent = "GPS非対応ブラウザ"; return;
  }
  status.textContent = "GPS検索中...";
  navigator.geolocation.watchPosition(updateRedPin, (err) => {
    status.textContent = "GPSエラー: " + err.message;
  }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
}

function updateRedPin(pos) {
  if (!mapTransform) return;
  
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const acc = pos.coords.accuracy;
  
  const p = mapTransform(lat, lon);
  
  let m = document.querySelector(".marker");
  if (!m) {
    m = document.createElement("div");
    m.className = "marker";
    m.innerHTML = `<div class="pin"></div>`;
    frame.appendChild(m);
  }
  
  m.style.left = p.x + "%";
  m.style.top  = p.y + "%";
  
  // 範囲内外の判定と表示切り替え
  if (p.x < 0 || p.x > 100 || p.y < 0 || p.y > 100) {
     m.classList.add("out-of-bounds");
     status.textContent = `範囲外: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
  } else {
     m.classList.remove("out-of-bounds");
     status.textContent = `現在地: ${lat.toFixed(6)}, ${lon.toFixed(6)} (精度±${Math.round(acc)}m)`;
  }
}
</script>
</body>
</html>
