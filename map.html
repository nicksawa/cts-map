<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CTS Map (Calibration Mode)</title>
<style>
  body { font-family: sans-serif; padding: 0; margin: 0; text-align: center; background: #f0f0f0; }
  .container { padding: 10px; max-width: 1000px; margin: auto; }
  .frame { 
    position: relative; 
    display: inline-block; 
    width: 100%;
    /* アスペクト比は自動計算されますが、初期表示用に確保 */
    min-height: 300px;
  }
  #mapimg { 
    display: block; 
    width: 100%; 
    height: auto; 
  }
  
  /* 現在地マーカー（赤） */
  .marker {
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 100;
    pointer-events: none;
    transition: left 0.5s linear, top 0.5s linear;
  }
  .pin {
    width: 16px; height: 16px;
    background: rgba(255, 0, 0, 0.9);
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
  }
  
  /* 基準点マーカー（青：調整用） */
  .ref-marker {
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 50;
    width: 12px; height: 12px;
    background: blue;
    border: 2px solid white;
    border-radius: 50%;
  }
  .ref-label {
    position: absolute;
    top: 14px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,100,0.8);
    color: white;
    font-size: 10px;
    padding: 2px 4px;
    border-radius: 3px;
    white-space: nowrap;
  }

  #status { margin-top: 10px; font-size: 14px; font-weight: bold; }
  .control-panel { 
    margin-bottom: 10px; text-align: left; background: #fff; padding: 10px; border-radius: 8px; 
    font-size: 12px;
  }
</style>
</head>
<body>

<div class="container">
  <h3>CTS Map (位置ズレ補正版)</h3>
  
  <div class="control-panel">
    <strong>設定手順:</strong><br>
    1. 地図上の<b>青い点 (LT, LB, RB)</b> が、AIPの座標点（角）と合っているか確認してください。<br>
    2. 合っていない場合（余白がある場合など）、下記コード内の <code>imgX, imgY</code> の%数値を調整してください。<br>
    3. 青い点が合致すれば、現在地（赤）は正確に表示されます。
  </div>

  <div class="frame" id="frame">
    <img id="mapimg" src="cts.jpg" alt="CTS Map">
  </div>

  <div id="status">システム準備中...</div>
</div>

<script>
//==========================
// 設定エリア (ここを調整！)
//==========================

// 1. 緯度経度 (AIPから読み取った座標)
function d(deg, min, sec) { return deg + min/60 + sec/3600; }

const GeoPoints = {
  LT: { lat: d(42,47,28.77), lon: d(141,41,55.93) }, // 左上
  LB: { lat: d(42,47,20.19), lon: d(141,40,19.59) }, // 左下
  RB: { lat: d(42,45,42.58), lon: d(141,42,13.89) }  // 右下
};

// 2. 画像上の位置 (％指定)
// 画像の端に余白がある場合、ここの数値を 0% や 100% から変更してください。
// 例: 左端に少し余白があるなら imgX: 2.5 (2.5%) など
const ImagePoints = {
  LT: { imgX: 0,   imgY: 0 },   // 左上 (通常 0, 0)
  LB: { imgX: 0,   imgY: 100 }, // 左下 (通常 0, 100)
  RB: { imgX: 100, imgY: 100 }  // 右下 (通常 100, 100)
};

//==========================
// アフィン変換ロジック (Meters -> Pixels)
//==========================

// 緯度経度 -> 平面メートル (簡易メルカトル)
function geoToMeters(lat, lon, baseLat) {
  const R_EARTH = 6378137;
  const rad = Math.PI / 180;
  const x = R_EARTH * (lon * rad) * Math.cos(baseLat * rad);
  const y = R_EARTH * (lat * rad);
  return { x, y };
}

let mapTransform = null; // 変換関数
const img = document.getElementById("mapimg");
const status = document.getElementById("status");
const frame = document.getElementById("frame");

// 画像ロード後に計算開始
img.addEventListener("load", () => {
  initMap();
});

function initMap() {
  // 青い基準点を描画
  drawRefMarker("LT", ImagePoints.LT);
  drawRefMarker("LB", ImagePoints.LB);
  drawRefMarker("RB", ImagePoints.RB);

  // 基準緯度
  const baseLat = (GeoPoints.LT.lat + GeoPoints.LB.lat + GeoPoints.RB.lat) / 3;

  // 1. 地理座標系 (メートル)
  const P1 = geoToMeters(GeoPoints.LT.lat, GeoPoints.LT.lon, baseLat); // Origin
  const P2 = geoToMeters(GeoPoints.LB.lat, GeoPoints.LB.lon, baseLat);
  const P3 = geoToMeters(GeoPoints.RB.lat, GeoPoints.RB.lon, baseLat);

  // 2. 画像座標系 (パーセント)
  const Q1 = { x: ImagePoints.LT.imgX, y: ImagePoints.LT.imgY }; // Origin
  const Q2 = { x: ImagePoints.LB.imgX, y: ImagePoints.LB.imgY };
  const Q3 = { x: ImagePoints.RB.imgX, y: ImagePoints.RB.imgY };

  // 3. 行列計算 (P -> Q)
  // ベクトル P
  const Px_v1 = P2.x - P1.x; const Py_v1 = P2.y - P1.y; // LT->LB
  const Px_v2 = P3.x - P1.x; const Py_v2 = P3.y - P1.y; // LT->RB

  // ベクトル Q
  const Qx_v1 = Q2.x - Q1.x; const Qy_v1 = Q2.y - Q1.y;
  const Qx_v2 = Q3.x - Q1.x; const Qy_v2 = Q3.y - Q1.y;

  // Matrix P = [[Px_v1, Px_v2], [Py_v1, Py_v2]]
  // Inverse P
  const det = Px_v1 * Py_v2 - Px_v2 * Py_v1;
  if (Math.abs(det) < 1e-9) {
    status.textContent = "エラー: 座標設定が無効です（直線上にあります）";
    return;
  }
  const invP = [
    [Py_v2 / det, -Px_v2 / det],
    [-Py_v1 / det, Px_v1 / det]
  ];

  // Matrix M = Matrix Q * Inverse P
  // m11 m12
  // m21 m22
  const m11 = Qx_v1 * invP[0][0] + Qx_v2 * invP[1][0];
  const m12 = Qx_v1 * invP[0][1] + Qx_v2 * invP[1][1];
  const m21 = Qy_v1 * invP[0][0] + Qy_v2 * invP[1][0];
  const m22 = Qy_v1 * invP[0][1] + Qy_v2 * invP[1][1];

  // 変換関数作成
  mapTransform = function(lat, lon) {
    const cur = geoToMeters(lat, lon, baseLat);
    // LTからの差分
    const dx = cur.x - P1.x;
    const dy = cur.y - P1.y;
    
    // アフィン変換
    const imgX = m11 * dx + m12 * dy + Q1.x;
    const imgY = m21 * dx + m22 * dy + Q1.y;

    return { x: imgX, y: imgY };
  };

  startGPS();
}

// 基準点マーカーを描画する関数
function drawRefMarker(name, pos) {
  let el = document.getElementById("ref-" + name);
  if (!el) {
    el = document.createElement("div");
    el.id = "ref-" + name;
    el.className = "ref-marker";
    el.innerHTML = `<div class="ref-label">${name}</div>`;
    frame.appendChild(el);
  }
  el.style.left = pos.imgX + "%";
  el.style.top  = pos.imgY + "%";
}

// GPS開始
function startGPS() {
  if (!navigator.geolocation) {
    status.textContent = "GPS非対応";
    return;
  }
  status.textContent = "GPS検索中...";
  navigator.geolocation.watchPosition(updatePos, (err) => {
    status.textContent = "GPSエラー: " + err.message;
  }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
}

function updatePos(pos) {
  if (!mapTransform) return;
  
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const acc = pos.coords.accuracy;

  const p = mapTransform(lat, lon);

  let m = document.querySelector(".marker");
  if (!m) {
    m = document.createElement("div");
    m.className = "marker";
    m.innerHTML = `<div class="pin"></div>`;
    frame.appendChild(m);
  }

  m.style.left = p.x + "%";
  m.style.top  = p.y + "%";
  
  // 範囲チェック
  if (p.x < 0 || p.x > 100 || p.y < 0 || p.y > 100) {
    status.textContent = `範囲外: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    m.style.opacity = "0.5";
  } else {
    status.textContent = `現在地: ${lat.toFixed(6)}, ${lon.toFixed(6)} (精度±${Math.round(acc)}m)`;
    m.style.opacity = "1";
  }
}
</script>

</body>
</html>
