<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CTS Map GPS (Auto Start & Affine)</title>

<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; }

  /* 画像アスペクト比固定：1023 / 1601 = 0.6396 */
  .frame {
    position: relative;
    width: 100%;
    padding-bottom: 63.96%; /* ← 重要：元画像の縦横比を固定 */
  }

  #mapimg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain; /* ← cover ではズレる。contain 必須 */
  }

  .marker {
    position: absolute;
    transform: translate(-50%, -100%);
    pointer-events: none;
    text-align: center;
    z-index: 100;
    transition: top 0.5s, left 0.5s;
  }

  .pin {
    width: 18px;
    height: 18px;
    background: rgba(220,30,30,0.95);
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 4px rgba(0,0,0,0.4);
    margin: 0 auto;
  }

  .label {
    margin-top: 4px;
    background: rgba(255,255,255,0.8);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
  }

  #status {
    margin-top: 10px;
    font-size: 12px;
    color: #333;
  }
</style>
</head>
<body>

<h3>CTS Map (Auto Start)</h3>

<div class="frame" id="frame">
  <img id="mapimg" src="CTS.jpg" alt="CTS Map">
</div>

<div id="status">位置情報を待機中...</div>

<script>
//==========================
// DMS → 10進数
//==========================
function d(deg, min, sec) {
  return deg + min/60 + sec/3600;
}

//==========================
// 基準3点（アフィン変換）
//==========================

// 左上（あなたが提供した値）
const LT = {
  lat: d(42, 47, 28.77),
  lon: d(141, 41, 55.93)
};

// 左下
const LB = {
  lat: d(42, 47, 20.19),
  lon: d(141, 40, 19.59)
};

// 右下
const RB = {
  lat: d(42, 45, 42.58),
  lon: d(141, 42, 13.89)
};

//==========================
// 緯度経度 → 平面メートル（ローカル）
//==========================
function geoToXY(lat, lon, baseLat) {
  const R = 6378137;
  const rad = Math.PI / 180;
  return {
    x: R * lon * rad * Math.cos(baseLat * rad),
    y: R * lat * rad
  };
}

//==========================
// 3点アフィン変換 行列作成
//==========================
function buildAffine() {
  const baseLat = LT.lat;

  const P1 = geoToXY(LT.lat, LT.lon, baseLat);
  const P2 = geoToXY(LB.lat, LB.lon, baseLat);
  const P3 = geoToXY(RB.lat, RB.lon, baseLat);

  // 画像上の基準位置（割合）
  const Q1 = {x: 0, y: 0};
  const Q2 = {x: 0, y: 1};
  const Q3 = {x: 1, y: 1};

  // P 座標系
  const px1 = P1.x, py1 = P1.y;
  const px2 = P2.x, py2 = P2.y;
  const px3 = P3.x, py3 = P3.y;

  // ベクトル
  const v1 = {x: px2 - px1, y: py2 - py1};
  const v2 = {x: px3 - px1, y: py3 - py1};

  // 逆行列
  const det = v1.x * v2.y - v2.x * v1.y;
  const inv = {
    a:  v2.y / det,
    b: -v2.x / det,
    c: -v1.y / det,
    d:  v1.x / det
  };

  const qv1 = {x: Q2.x - Q1.x, y: Q2.y - Q1.y};
  const qv2 = {x: Q3.x - Q1.x, y: Q3.y - Q1.y};

  const M = {
    m11: qv1.x * inv.a + qv2.x * inv.c,
    m12: qv1.x * inv.b + qv2.x * inv.d,
    m21: qv1.y * inv.a + qv2.y * inv.c,
    m22: qv1.y * inv.b + qv2.y * inv.d,
    t1: Q1.x - (qv1.x * inv.a + qv2.x * inv.c) * px1 - (qv1.x * inv.b + qv2.x * inv.d) * py1,
    t2: Q1.y - (qv1.y * inv.a + qv2.y * inv.c) * px1 - (qv1.y * inv.b + qv2.y * inv.d) * py1
  };

  return {M, baseLat};
}

const {M, baseLat} = buildAffine();

//==========================
// 位置更新
//==========================
function updateMarker(lat, lon) {
  const p = geoToXY(lat, lon, baseLat);

  // 画像内の割合
  let x = M.m11 * p.x + M.m12 * p.y + M.t1;
  let y = M.m21 * p.x + M.m22 * p.y + M.t2;

  // 割合 → CSS 位置
  const frame = document.getElementById("frame");
  const marker = document.getElementById("marker");

  marker.style.left = (x * 100) + "%";
  marker.style.top  = (y * 100) + "%";
}

//==========================
// マーカー作成
//==========================
const m = document.createElement("div");
m.id = "marker";
m.className = "marker";
m.innerHTML = `<div class="pin"></div><div class="label">GPS</div>`;
document.body.appendChild(m);

//==========================
// GPS 自動開始
//==========================
navigator.geolocation.watchPosition(
  pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    updateMarker(lat, lon);

    document.getElementById("status").innerText =
      `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
  },
  err => {
    document.getElementById("status").innerText =
      "GPS取得エラー: " + err.message;
  },
  { enableHighAccuracy: true }
);

</script>
</body>
</html>
